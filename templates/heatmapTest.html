<!DOCTYPE html>
<html>
<head>
  <!--        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"-->
  <!--        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="-->
  <!--        crossorigin=""/>-->
  <!--        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"-->
  <!--        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="-->
  <!--        crossorigin=""></script>-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-heatmap@1.0.0/leaflet-heatmap.min.js"></script>

  <style>
    #map { width: 900px; height: 800px; }
  </style>
</head>
<body>

<div id="map"></div>


<script src="../fill_hex.js"></script>
<script src="../gaussian.js"></script>
<script>

  const Q = 20; // 배출량 (g/s)
  const u = 2.0; // 평균 풍속 (m/s)
  const sigmaY = 20; // 수평 확산 계수 (m)
  const sigmaZ = 10; // 수직 확산 계수 (m)
  const H = 35; // 배출 높이 (m)      // 최대 높이가 거의 50m입니다.

  let startLat = 35.1188093910081;
  let startLng = 128.96808496718;
  let distance = 0.0;
  let pointDist = 0.0;
  let n = 50;
  let hexDist = 0.01;
  let angle = 350;

  // 맵과 히트맵 레이어 초기화
  var map = L.map('map', {
    center: [startLat, startLng],
    zoom: 14,
  });

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // 풍속 데이터에 따른 예상 이동 경로의 길이 계산
  distance = calcul_moveDist(u, 30);
  pointDist = distance / n;
  // 시작점 농도
  let start_density = calculateConcentration(Q,u,sigmaY,sigmaZ,H,0,0,1);
  // 예상 이동 경로 위에 일정한 간격으로 측정 위치 할당.
  let pointList = pointSet(startLat, startLng, n, distance, angle);

  // 지수형태의 density를
  function removeExponential(numberInExponential) {
    // e 지수 형식의 숫자를 받아서 처리
    if (typeof numberInExponential !== 'number') {
      console.error('Invalid input. Please provide a valid number.');
      return null;
    }
    // 지수 형식의 문자열로 변환
    const numberAsString = numberInExponential.toString();
    // e 지수의 위치 확인
    const indexOfE = numberAsString.indexOf('e');
    // e 지수가 없으면 그대로 반환
    if (indexOfE === -1) {
      return numberInExponential;
    }
    // e 지수를 기준으로 숫자와 지수 부분 분리
    const base = parseFloat(numberAsString.slice(0, indexOfE));
    // console.log(base);
    const exponent = parseInt(numberAsString.slice(indexOfE + 2));
    // console.log(exponent)
    // base * Math.pow(10, exponent)
    // 숫자와 지수를 곱하여 반환
    return base;
  }

  function normalizeValues(values) {
    // 주어진 값들 중 가장 작은 값을 찾음
    const minValue = Math.min(...values);

    // 정규화된 값을 저장할 배열
    const normalizedValues = [];

    // 모든 값에 대해 정규화 수행
    for (let value of values) {
      // 가장 작은 값을 뺀 값
      const diff = value - minValue;

      // 음수인 경우 0으로 처리
      const normalizedValue = Math.max(diff, 0);

      // 정규화된 값은 가장 작은 값으로부터의 차이값을 사용
      normalizedValues.push(normalizedValue);
    }

    return normalizedValues;
  }

  function generateDensityData(pointList) {
    return pointList.map(location => {
      const latitude = location[0];
      const longitude = location[1];
      let x = latToKm(startLat - latitude);
      let y = lngToKm(latitude, startLng - longitude);
      let density = calculateConcentration(Q,u,sigmaY,sigmaZ,H, x, y, 1);
      density = removeExponential(density) * (10 ** 11);
      return { latitude, longitude, density };
    });
  }
  let densityData = generateDensityData(pointList);

  // densityData = normalizeValues(densityData);
  console.log(densityData)
  let maxDensity = densityData[0].density;
  let minDensity = densityData[n].density;
  let range = maxDensity - minDensity;
  for(let i = 0; i <= n; i++)  {
    densityData[i].density -= minDensity;
  }
  // 히트맵 설정 객체
  var cfg = {
    min : 0,
    max : range,
    radius: 50,    //
    maxOpacity: .5, // .5
    scaleRadius: false,
    useLocalExtrema: true,
    latField: 'latitude',
    lngField: 'longitude',
    valueField: 'density' // 농도
  };

  // 히트맵 레이어 생성(map에 추가)
  var heatmapLayer = new HeatmapOverlay(cfg).addTo(map);

  var testData = {
    max: 9, // 이 값은 조정이 필요할 수 있습니다. 데이터에 따라 최대값 설정, 어떤 값이 max?..
    data: densityData
  };

  // 찍은 점들 마커로 위치 표시하기
  function addMarkersToMap(map, coords, n) {
    for(let i = 0; i <= n; i++) {
      L.marker(coords[i]).addTo(map).bindPopup(`density : ${densityData[i].density}`);
    }
  }
  //addMarkersToMap(map, pointList, n);

  console.log(testData);

  // 풍향에 따라 선을 그리자.. 그리고 그 선

  heatmapLayer.setData(testData);

</script>
</body>
</html>
